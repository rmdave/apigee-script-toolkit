#!/bin/bash

# getApis
#
# lists the apis contained in a given host
#
# usage:
#   getApis host_alias

#set -e

USAGE="host_alias 	# ouput is simple list"
TOOLSDIR="${APITOOLS_HOME}"

#debug "1HOST_ALIAS=$HOST_ALIAS; ENVIRONMENT=$ENVIRONMENT; ORGANIZATION=$ORGANIZATION"

. "$TOOLSDIR/config/global"
#debug "2HOST_ALIAS=$HOST_ALIAS; ENVIRONMENT=$ENVIRONMENT; ORGANIZATION=$ORGANIZATION"

. "$TOOLSDIR/lib/functions"
debug "3HOST_ALIAS=$HOST_ALIAS; ENVIRONMENT=$ENVIRONMENT; ORGANIZATION=$ORGANIZATION"

parseCommandline "$@"
debug "4HOST_ALIAS=$HOST_ALIAS; ENVIRONMENT=$ENVIRONMENT; ORGANIZATION=$ORGANIZATION"
checkArgs 1
debug "5HOST_ALIAS=$HOST_ALIAS; ENVIRONMENT=$ENVIRONMENT; ORGANIZATION=$ORGANIZATION"
loadConfig "${ARGS[0]}"
debug "6HOST_ALIAS=$HOST_ALIAS; ENVIRONMENT=$ENVIRONMENT; ORGANIZATION=$ORGANIZATION"


URL="${APIGEE_HOST}/o/${ORGANIZATION}/apis"
debug "retrieving APIs from ${URL}"
http_get "$URL"
if [ "$STATUS_CODE" != "200" ]; then
	fail "$(basename "$0") failed with status $STATUS_CODE: $RESPONSE"
fi

debug "Parsing: \n$RESPONSE" 

if [ "$FRMT" = "json" ] ; then
	APILIST=`echo "$RESPONSE" | sed -e 's/[",\[]//g'`
	#debug "APILIST= $APILIST"
	args=( $APILIST )
	args=( "${args[@]:1:$(( ${#args[@]} - 2 ))}" )
	APILIST="${args[*]}"
	#debug "APILIST= $APILIST"
else
	APILIST=`echo "$RESPONSE" | xmlValueOf "Item"`
fi

debug "APILIST=$APILIST"
#echo "."

for a in $APILIST ; do printf "%b\n" $a | sed 's/\"//g' ; done

#!/bin/bash

set -x

APINAME=$1
SUBSFILE=$2

WKDR="${HOME}/myworkspace/"
OLDR="${WKDR}bundles/"
UPDR="${WKDR}upstage/"
NWDR="${WKDR}fixedup/"

function error () {
	err=$1; shift
	echo -e "$@"
	exit $err
}

if [ "_$SUBSFILE" != "" ] ; then
        for d in proxies targets ; do
        	cd ${OLDR}${APINAME}/apiproxy/${d}
        	for f in `ls *.xml` ; do
                	newf="$(basename $f .xml)"
                	cp ${newf}.xml ${newf}.bkp
                	sed -f ${UPDR}subbers.${SUBSFILE} ${newf}.xml > ${newf}.tmp
                	if [[ $? -le 1 && ! -z ${newf}.tmp ]] ; then
                        	mv ${newf}.tmp ${newf}.xml
                        	# rm ${newf}-.bkp
                	else
                        	error 2 "Substitutions Failed"
                	fi
        	done
        done
fi

cd $WKDR
rm -rf ${NWDR}apiproxy

# copy in the current bundle
cp -R ${OLDR}${APINAME}/apiproxy ${NWDR}

# upload new resources
cp -R ${UPDR}policies/* ${NWDR}apiproxy/policies
cp -R ${UPDR}resources/* ${NWDR}apiproxy/resources

ls ${UPDR}policies/*
ls ${UPDR}resources/*/*